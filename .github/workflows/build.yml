on:
  workflow_call:
    inputs:
      docker:
        required: false
        type: string
      host:
        required: true
        type: string
      if:
        description: 'Whether to run this job'
        required: false
        default: true
        type: boolean
      publish:
        required: false
        type: string
      setup:
        required: false
        type: string
      target:
        required: true
        type: string
jobs:
  reusable-build:
    if: ${{ inputs.if }}
    name: stable - ${{ inputs.target }} - python@3.12
    runs-on: ${{ inputs.host }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            .cargo-cache
            target/
          key: ${{ inputs.target }}-cargo-${{ inputs.host }}
      - name: Install zig
        uses: mlugg/setup-zig@v1
        if: ${{ inputs.target == 'armv7-unknown-linux-gnueabihf' }}
        with:
          version: 0.13.0
      - name: Setup toolchain
        run: ${{ inputs.setup }}
        if: ${{ inputs.setup }}
        shell: bash
      - name: Install Bindgen
        run: |
          cargo install --force --locked bindgen-cli
      - name: Install nasm for i686-pc-windows-msvc
        uses: ilammy/setup-nasm@v1
        if: inputs.target == 'i686-pc-windows-msvc'
      - name: Setup x86 Python for i686-pc-windows-msvc
        if: ${{ inputs.target == 'i686-pc-windows-msvc' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          architecture: "x86"
      - name: Setup arm64 Python for aarch64-pc-windows-msvc
        if: ${{ inputs.target == 'aarch64-pc-windows-msvc' }}
        run: |
          # Download Python installer
          curl -O https://www.python.org/ftp/python/3.12.10/python-3.12.10-arm64.exe
          
          # Install Python with necessary components
          ./python-3.12.10-arm64.exe /quiet InstallAllUsers=1 PrependPath=1 Include_launcher=1 Include_test=0 Include_pip=1 Include_dev=1
          
          # Verify Python installation
          python --version
          pip --version
      - name: Setup Windows Build Environment
        if: ${{ contains(inputs.target, 'windows') }}
        run: |
          # Set environment variables for Python and Windows SDK
          $env:LIB = "C:\hostedtoolcache\windows\Python\3.12.10\x64\libs;$env:LIB"
          $env:WindowsSdkDir = "C:\Program Files (x86)\Windows Kits\10"
          $env:WindowsSdkVersion = "10.0.22621.0"
          $env:WindowsSdkBinPath = "$env:WindowsSdkDir\bin\$env:WindowsSdkVersion"
          $env:VCToolsVersion = "14.42.34438"
          $env:VCToolsInstallDir = "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Tools\MSVC\$env:VCToolsVersion"
          $env:PATH = "$env:VCToolsInstallDir\bin\Hostx64\x64;$env:WindowsSdkBinPath\x64;$env:PATH"
          
          # Verify environment setup
          echo "Python LIB path: $env:LIB"
          echo "Windows SDK Version: $env:WindowsSdkVersion"
          echo "Visual C++ Tools Version: $env:VCToolsVersion"
      - name: Build and (Publish) x86_64-unknown-linux-musl
        uses: addnab/docker-run-action@v3
        if: ${{ inputs.target == 'x86_64-unknown-linux-musl' }}
        with:
          image: ${{ inputs.docker }}
          options: '-e SHOULD_PUBLISH=${{ inputs.publish }} --user 0:0 -v ${{ github.workspace }}/.cargo-cache/git/db:/usr/local/cargo/git/db -v ${{ github.workspace }}/.cargo/registry/cache:/usr/local/cargo/registry/cache -v ${{ github.workspace }}/.cargo/registry/index:/usr/local/cargo/registry/index -v ${{ github.workspace }}:/build -w /build'
          run: |
            pwd
            ls -lah
            whoami
            env
            echo "apk add:"
            apk add musl-dev gcc make cmake clang llvm build-base python3-dev
            export CARGO_BUILD_TARGET="x86_64-unknown-linux-musl"
            ln -s /usr/lib/gcc/x86_64-alpine-linux-musl/14.2.0/crtbeginS.o /usr/lib
            ln -s /usr/lib/gcc/x86_64-alpine-linux-musl/14.2.0/crtendS.o /usr/lib
            ln -s /usr/lib/gcc/x86_64-alpine-linux-musl/14.2.0/libgcc.a /usr/lib
            echo "apk update:"
            apk update
            rustup target add x86_64-unknown-linux-musl
            echo "create venv:"
            python3 -m venv .env
            . .env/bin/activate && pip install -r requirements.txt
            . .env/bin/activate && pip install patchelf
            if [ "${SHOULD_PUBLISH}" == 'true' ]; then
              echo "~~~~ maturin publishing"
              . .env/bin/activate && maturin publish --no-sdist -u __token__ -p ${{ secrets.MATURIN_PASSWORD }}
            else
              echo "~~~~ maturin building"
              . .env/bin/activate && maturin build
            fi
      - name: Build and (Publish) aarch64-unknown-linux-gnu
        uses: addnab/docker-run-action@v3
        if: ${{ inputs.target == 'aarch64-unknown-linux-gnu' }}
        with:
          image: ${{ inputs.docker }}
          options: '-e SHOULD_PUBLISH=${{ inputs.publish }} --user 0:0 -v ${{ github.workspace }}/.cargo-cache/git/db:/usr/local/cargo/git/db -v ${{ github.workspace }}/.cargo/registry/cache:/usr/local/cargo/registry/cache -v ${{ github.workspace }}/.cargo/registry/index:/usr/local/cargo/registry/index -v ${{ github.workspace }}:/build -w /build'
          run: |
            pwd
            ls -lah
            whoami
            env
            curl --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --profile minimal
            export PATH="$HOME/.cargo/bin:$PATH"
            # ring 0.17 assembly build needs __ARM_ARCH set
            export CFLAGS_aarch64_unknown_linux_gnu="-D__ARM_ARCH=8"
            rustup component add llvm-tools-preview || true
            rustup target add aarch64-unknown-linux-gnu
            python3 -m venv .env
            . .env/bin/activate && pip install -r requirements.txt
            . .env/bin/activate && pip install patchelf
            # this is in raw 'sh', use single '='
            if [ "${SHOULD_PUBLISH}" = 'true' ]; then
              echo "~~~~ maturin publishing"
              # pass '--debug' to avoid optimization, which breaks tls signature validation on this platform
              . .env/bin/activate && maturin publish --target ${{ inputs.target }} --no-sdist --debug -u __token__ -p ${{ secrets.MATURIN_PASSWORD }}
            else
              echo "~~~~ maturin building"
              . .env/bin/activate && maturin build --target ${{ inputs.target }}
            fi
      - name: Build Python Extension Module (non-docker)
        if: ${{ inputs.publish != true && !inputs.docker && !contains(inputs.target,'android') }}
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ inputs.target }}
          # builds in release mode with the specified python version as the interpreter and the Cargo.toml file as the manifest
          args: --release -i python3.12 --target ${{ inputs.target }} -m Cargo.toml
      - name: Publish to PyPI (non-docker)
        if: ${{ inputs.publish == true && !inputs.docker && !contains(inputs.target,'android') }}
        uses: PyO3/maturin-action@v1
        with:
          command: publish
          target: ${{ inputs.target }}
          args: --no-sdist -i python3.12 -m Cargo.toml -u __token__ -p ${{ secrets.MATURIN_PASSWORD }}
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: bindings-${{ inputs.target }}
          path: target/wheels/*.whl # path to the python wheel package
          if-no-files-found: error
